name: main

on:
  push:
    branches: [ "main" ]

jobs:
  editorconfig-checker:
    name: Editorconfig Checker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Editorconfig check
        uses: editorconfig-checker/action-editorconfig-checker@main
      - name: Editorconfig check
        run: editorconfig-checker

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Markdown Lint
        run: npx markdown-cli *.md

  git-leaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: git-leaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: ["editorconfig-checker", "markdown-lint", "git-leaks"]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Execute Unit Tests
        run: |-
          go mod download
          go test github.com/vladoiliev02/online-store/dao

  database-tests:
    name: Database Test
    needs: ["editorconfig-checker", "markdown-lint", "git-leaks"]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_DB: db
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Execute migration test
        uses: joshuaavalon/flyway-action@v3.0.0
        with:
          url: jdbc:postgresql://postgres:5432/db
          user: user
          password: password
